#
# Tests for SHOW EXPLAIN FOR functionality
#
--disable_warnings
drop table if exists t0, t1;
--enable_warnings

create table t0 (a int);
insert into t0 values (0),(1),(2),(3),(4),(5),(6),(7),(8),(9);
create table t1 (a int);
insert into t1 select A.a + 10*B.a + 100*C.a from t0 A, t0 B, t0 C;
alter table t1 add b int, add c int, add filler char(32);
update t1 set b=a, c=a, filler='fooo';
alter table t1 add key(a), add key(b);

# 
# Try killing a non-existent thread
# 
--error ER_NO_SUCH_THREAD
show explain for 2*1000*1000*1000;

--error ER_NOT_SUPPORTED_YET
show explain for (select max(a) from t0);

# 
# Setup two threads and their ids
#
let $thr1=`select connection_id()`;
connect (con1, localhost, root,,);
connection con1;
let $thr2=`select connection_id()`;
connection default;

# SHOW EXPLAIN FOR <idle thread>
--error ER_ERROR_WHEN_EXECUTING_COMMAND
evalp show explain for $thr2;

# SHOW EXPLAIN FOR <ourselves>
--error ER_ERROR_WHEN_EXECUTING_COMMAND
evalp show explain for $thr1;

let $wait_condition= select State='show_explain_trap' from information_schema.processlist where id=$thr2;

#
# Test SHOW EXPLAIN for simple queries
#
connection con1;
set debug='d,show_explain_probe_1';
send select count(*) from t1 where a < 100000;

connection default;
--source include/wait_condition.inc
evalp show explain for $thr2;
connection con1;
reap;


set debug='d,show_explain_probe_1';
send select max(c) from t1 where a < 10;
connection default;
--source include/wait_condition.inc
evalp show explain for $thr2;
connection con1;
reap;

# We can catch EXPLAIN, too.
set optimizer_switch='index_condition_pushdown=on,mrr=on,mrr_sort_keys=on';
set debug='d,show_explain_probe_1';
send explain select max(c) from t1 where a < 10;
connection default;
--source include/wait_condition.inc
evalp show explain for $thr2;
connection con1;
reap;


## TODO: Test this: multiple SHOW EXPLAIN calls in course of running of one select
## 
## TODO: Test this: have several SHOW EXPLAIN requests be queued up for a
##       thread and served together.

drop table t0,t1;
